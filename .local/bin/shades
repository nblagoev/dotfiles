#!/bin/bash

tmux_path="$HOME/.config/tmux/tmux.conf"
helix_path="$HOME/.config/helix/config.toml"
starship_path="$HOME/.config/starship.toml"
gitconfig_path="$HOME/.gitconfig"
fzfrc_path="$HOME/.config/fzfrc"
batconfig_path="$HOME/.config/bat/config"
yazi_path="$HOME/.config/yazi/theme.toml"
btop_path="$HOME/.config/btop/btop.conf"
nvim_path="$HOME/.config/nvim/init.lua"

terafox_colors=(
  "border:#2d4f56" "fg:#e6eaea" "bg:#0f1c1e" "hl:#4d7d90" "fg+:#e6eaea" "bg+:#293e40" "hl+:#73a3b7"
  "info:#afd4de" "prompt:#934e69" "pointer:#d96f3e" "marker:#8eb2af" "spinner:#d96f3e" "header:#587b7b"
)
dayfox_colors=(
  "border:#aab0ad" "fg:#3d2b5a" "bg:#e4dcd4" "hl:#8b369a" "fg+:#3d2b5a" "bg+:#e7d2be" "hl+:#8b369a"
  "info:#30583c" "prompt:#5e2baf" "pointer:#643f61" "marker:#ac5402" "spinner:#643f61" "header:#824d5b"
)

open -g raycast://extensions/raycast/system/toggle-system-appearance
sleep 0.5
if [[ $(defaults read -g AppleInterfaceStyle == "Dark" 2>/dev/null) ]]; then
  # Dark Mode
  from_theme="dayfox"
  to_theme="terafox"
  from_colors=("${dayfox_colors[@]}")
  to_colors=("${terafox_colors[@]}")
  helix_theme="catppuccin_mocha"
  nvim_background="dark"
else
  # Light Mode
  from_theme="terafox"
  to_theme="dayfox"
  from_colors=("${terafox_colors[@]}")
  to_colors=("${dayfox_colors[@]}")
  helix_theme="catppuccin_latte"
  nvim_background="light"
fi

sed -i '' "1s/theme = .*/theme = \"$helix_theme\"/" "$helix_path"
sed -i '' "s/palette = .*/palette = \"$to_theme\"/" "$starship_path"
sed -i '' "s/colorscheme $from_theme/colorscheme $to_theme/" "$nvim_path"

files_to_update=("$tmux_path" "$gitconfig_path" "$batconfig_path" "$yazi_path" "$btop_path")
sed -i '' "s/$from_theme/$to_theme/" "${files_to_update[@]}"

# Update fzf colors
fzf_sed_args=()
for i in "${!to_colors[@]}"; do
  fzf_sed_args+=(-e "s/${from_colors[i]}/${to_colors[i]}/")
done
sed -i '' "${fzf_sed_args[@]}" "$fzfrc_path"

# Refresh running Neovim instances
for socket in $(find "$TMPDIR" -name "nvim*" -type s 2>/dev/null); do
  ~/.local/share/bob/nvim-bin/nvim --server "$socket" --remote-send "<Esc><Cmd>set background=$nvim_background<cr>"
done

if pgrep -x "tmux" >/dev/null; then
  # Signal Helix to reload its config in all tmux panes
  tmux_panes=$(tmux list-panes -a -F "#{session_id}:#{window_id}.#{pane_id};#{pane_current_command}")
  for pane in $tmux_panes; do
    if [[ "hx" == "$(echo "$pane" | cut -d ";" -f2)" ]]; then
      pane_id="$(echo "$pane" | cut -d ";" -f1)"
      tmux send-keys -t "$pane_id" Escape
      tmux send-keys -t "$pane_id" ":config-reload" Enter
    fi
  done

  tmux source-file "$HOME/.config/tmux/tmux.conf"
fi
